# kate: indent-width 2;

variables:
  TRAVIS_BRANCH: $(Build.SourceBranchName)
  TRAVIS_COMMIT: $(Build.SourceVersion)


.jobtpl:
  before_script: |
    export BASEIMAGE="${MY_MODULE}-testing_${DOCKER_TAG}:${TRAVIS_BRANCH/\//_}"
    export IMAGE="dunecommunity/ci_${MY_MODULE}-testing_${DOCKER_TAG}:${TRAVIS_COMMIT}"
    # get image with fallback to master branch of the super repo
    docker pull dunecommunity/${BASEIMAGE} || export BASEIMAGE="${MY_MODULE}-testing_${DOCKER_TAG}:master" ; docker pull dunecommunity/${BASEIMAGE}
    export ENV_FILE=${HOME}/env
    mkdir ${CI_PROJECT_DIR}/testresults && chmod -R 777 ${CI_PROJECT_DIR}/testresults
    DOCKER_RUN="docker run -v ${CI_PROJECT_DIR}/testresults:/home/dune-ci/testresults --env-file ${ENV_FILE} ${IMAGE}"
    docker build --build-arg BASE=${BASEIMAGE} -t ${IMAGE} -f .ci/shared/docker/ci_run/Dockerfile .
    docker inspect ${IMAGE}
  script: |
    python3 ./.ci/shared/scripts/make_env_file.py
    ${DOCKER_RUN} /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash
    ${DOCKER_RUN} /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

  after_script: |
    echo $DOCKER_PW | docker login --username="$DOCKER_USER" --password-stdin
    docker push ${IMAGE}

  artifacts:
    reports:
      junit: '${CI_PROJECT_DIR}/testresults/*xml'
